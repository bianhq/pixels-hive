# pixels-hive
This is the Pixels `Hive SerDe` (short for “Serializer and Deserializer.”).
Hive uses SerDe and the corresponding FileFormat to read and write tables.

The flow of deserialization is:
```
HDFS files –> InputFileFormat –> <key, value> –> Deserializer –> Row object
```
While the flow of serialization is:
```
Row object –> Serializer –> <key, value> –> OutputFileFormat –> HDFS files
```

## Compatibility
Pixels Serde has been tested on Hive 2.1 and 2.3. Other Hive versions that are compatible
with the SerDe API in Hive 2.3 should also work well with Pixels SerDe.

Currently, Pixels Hive SerDe only supports HDFS as the underlying storage.

## Use Pixels in Hive

Build pixels-hive using `mvn package`. Find the `pixels-hive-*-full.jar` under the `target` directory.
This is the SerDe that can be used in Hive.

### Load Pixels SerDe
There are two options to load Pixels SerDe in Hive:

* In Hive cli:
```sql
hive> add jar {PATH}/pixels-hive-0.1.0-SNAPSHOT-full.jar
```
* You can also put `pixels-hive-0.1.0-SNAPSHOT-full.jar` in the path `apache-hive-2.1.1-bin/auxlib/`. Then Hive will load the jar when launching.

### Create Table
Create tables in Hive with the syntax in [Hive Language Manual](https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-Create/Drop/Alter/UseDatabase).
Within the `CREATE TABLE` statement, use the following `ROW FORMAT` and `TABLEPROPERTY`:
```SQL
ROW FORMAT SERDE
  'io.pixelsdb.pixels.hive.PixelsSerDe' 
STORED AS INPUTFORMAT 
  'io.pixelsdb.pixels.hive.mapred.PixelsInputFormat' 
OUTPUTFORMAT 
  'io.pixelsdb.pixels.hive.mapred.PixelsOutputFormat'
LOCATION
  'hdfs://hostname:9000/path/to/pixels/files'
TBLPROPERTIES ('bind.pixels.table'='schema_name.table_name')
```
`LOCATION` is necessary. It should be the same as the `order_path`
or `compact_path` in Pixels metadata. `bind.pixels.table` specifies
which table in Pixels to be bind with this Hive table. Replace the `schema_name`
and `table_name` with the right schema and table name in Pixels.

**Note**: It is a better to create an EXTERNAL table. Internal table will delete the data
when the table is dropped.

### Load Data
Load data by `pixels-load` and then it is ready to execute queries in Hive.
Currently, we have only implemented `PixelsInputFormat` for hive,
so that data can not be loaded through Hive's `LOAD` command.
An example is [here](https://github.com/pixelsdb/pixels#load-data).

### Run Queries
Before executing a query, set `hive.input.format` in the session:
```sh
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
```
The default `hive.input.format` is `CombineHiveInputFormat`, which
will not invoke our dynamic splitting algorithm to generate the input
splits for MapReduce jobs. Pixels SerDe currently declines to read
and process splits generated by `CombineHiveInputSplit`.

In addition, it is better to set a smaller value for the max
reducers in a job, such as:
```sh
set hive.exec.reducers.max=16
```
Pixels is an efficient columnar store for wide tables.
Thus it is likely that only a very small portion of data is read from each split.
The default reducer number in Hive is estimated by the total size
of the input splits `(num_reducer=min(hive.exec.reducers.max, (total_input_size/N))`, which is generally much larger than the
actual number of reducers we need. The default max reducers in Hive
2.x is 1099.

**Note:** the logs of pixels-hive are included in the Hive log file that is located at `\tmp\{user_name}\hive.log`
 by default.